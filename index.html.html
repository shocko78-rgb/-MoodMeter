<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>무지개 마음판별 챗봇 (무료 · WebLLM)</title>
  <meta name="description" content="서버·API키 없이 브라우저에서만 동작하는 무지개 마음판별 챗봇(WebLLM)" />
  <style>
    :root{ --bg:#0b0f1a; --panel:#0f1629; --border:#1d2a54; --text:#eaf0ff; --muted:#9fb3d6; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic}
    .wrap{max-width:900px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(#ff4d4f,#ff7a45,#ffa940,#ffd666,#73d13d,#36cfc9,#40a9ff,#9254de,#ff4d4f)}
    h1{font-size:20px;margin:0}
    .tagline{font-size:13px;color:var(--muted)}
    .card{margin-top:16px;border:1px solid var(--border);background:var(--panel);border-radius:18px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .ribbon{height:6px;background:linear-gradient(90deg,#ff4d4f,#ff7a45,#ffa940,#ffd666,#73d13d,#36cfc9,#40a9ff,#9254de)}
    .sys{padding:12px 16px;border-bottom:1px dashed var(--border);font-size:13px;color:var(--muted);white-space:pre-wrap}
    .msgs{height:min(60vh,540px);overflow:auto;padding:16px}
    .msg{display:flex;gap:10px;margin:0 0 14px}
    .role{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;font-weight:700;flex:0 0 auto}
    .role.u{background:#243057;color:#c7d7ff}
    .role.a{background:#1f3a2e;color:#ccf3d6}
    .bubble{background:#0c1430;border:1px solid #203160;padding:10px 12px;border-radius:12px;white-space:pre-wrap;word-break:break-word;max-width:92%}
    .input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
    textarea{flex:1;resize:none;min-height:56px;max-height:200px;padding:12px;border-radius:12px;border:1px solid #2a3a6b;background:#0f1836;color:var(--text)}
    button{padding:12px 16px;border-radius:12px;border:1px solid #2a3a6b;background:linear-gradient(180deg,#1e2a57,#172248);color:#fff;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:12px 16px;border-top:1px dashed var(--border)}
    .chip{background:#172246;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .notice{padding:10px 16px;color:#ffd666;font-size:13px;border-top:1px dashed var(--border)}
    footer{color:var(--muted);font-size:12px;text-align:center;margin-top:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>무지개 마음판별 챗봇 (무료 · WebLLM)</h1>
          <div class="tagline">서버 없이 · API키 없이 · 브라우저에서만 실행</div>
        </div>
      </div>
    </header>

    <div class="card">
      <div class="ribbon"></div>
      <div class="sys" id="sys"></div>

      <div class="msgs" id="msgs"></div>

      <div class="input">
        <textarea id="prompt" placeholder="Shift+Enter 줄바꿈, Enter 전송"></textarea>
        <button id="send">보내기</button>
      </div>

      <div class="toolbar">
        <span class="chip">오늘 감정 일기 피드백</span>
        <span class="chip">세대 차이 활동 2개</span>
        <span class="chip">마주 대화 규칙 5가지</span>
      </div>

      <div class="notice" id="notice">모델 로딩 준비중… (최초 실행은 수백 MB 다운로드로 시간이 걸릴 수 있어요)</div>
    </div>

    <footer>브라우저가 <b>WebGPU</b>를 지원해야 잘 동작합니다(크롬 최신 권장). 처음만 느리고, 두 번째부터는 빨라져요.</footer>
  </div>

<script type="module">
  import { CreateMLCEngine } from 'https://esm.run/@mlc-ai/web-llm';

  const sysEl = document.getElementById('sys');
  const msgsEl = document.getElementById('msgs');
  const promptEl = document.getElementById('prompt');
  const sendBtn = document.getElementById('send');
  const noticeEl = document.getElementById('notice');

  const SYSTEM_PROMPT = `당신은 초등 4학년 담임교사를 돕는 "무지개 마음판별 챗봇"입니다.
- 목적: 학생 감정(무드미터) 점검, 공감 피드백, 도덕 활동 제안.
- 핵심가치: 공감·배려·존중.
- 톤: 따뜻하고 명확, 활동 제안 시 단계·준비물·주의점 포함.
- 위험/민감 주제는 안전수칙과 보호자·전문가 상담 안내를 우선.`;

  sysEl.textContent = SYSTEM_PROMPT;

  // 메시지 상태
  let history = []; // {role:'user'|'assistant', content:string}[]

  function addBubble(role, content){
    const row = document.createElement('div'); row.className='msg';
    const r = document.createElement('div'); r.className='role ' + (role==='user'?'u':'a'); r.textContent = role==='user'?'U':'A';
    const b = document.createElement('div'); b.className='bubble'; b.textContent = content;
    row.appendChild(r); row.appendChild(b); msgsEl.appendChild(row); msgsEl.scrollTop = msgsEl.scrollHeight;
    return b;
  }

  // 빠른 질문
  document.querySelectorAll('.chip').forEach(c=>{
    c.addEventListener('click', ()=>{ promptEl.value = c.textContent; promptEl.focus(); });
  });

  // Enter 전송
  promptEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
  });
  sendBtn.onclick = send;

  // 엔진 초기화 (무료 Llama-3.1-8B-Instruct 권장)
  let engine;
  try {
    engine = await CreateMLCEngine('Llama-3.1-8B-Instruct', {
      initProgressCallback: (p) => {
        const pct = Math.round((p.progress||0)*100);
        noticeEl.textContent = `모델 로딩: ${pct}% (첫 실행은 용량이 커서 오래 걸릴 수 있어요)`;
      },
    });
    noticeEl.textContent = '모델 로딩 완료! 이제 대화할 수 있어요.';
  } catch (e) {
    noticeEl.textContent = '모델 로딩 실패: ' + e.message + ' (WebGPU 지원 브라우저인지 확인해 주세요)';
  }

  async function send(){
    const text = promptEl.value.trim(); if(!text || !engine) return;
    promptEl.value=''; promptEl.disabled = true; sendBtn.disabled = true;
    history.push({ role:'user', content:text });
    addBubble('user', text);
    const bubble = addBubble('assistant', '');

    try {
      const stream = await engine.chat.completions.create({
        messages: [{role:'system', content: SYSTEM_PROMPT}, ...history],
        stream: true
      });

      let reply = '';
      for await (const part of stream){
        const delta = part?.choices?.[0]?.delta?.content || '';
        reply += delta; bubble.textContent = reply; msgsEl.scrollTop = msgsEl.scrollHeight;
      }
      history.push({ role:'assistant', content: reply });
    } catch (err){
      bubble.textContent = '에러: ' + err.message;
    } finally {
      promptEl.disabled = false; sendBtn.disabled = false; promptEl.focus();
    }
  }
</script>
</body>
</html>
